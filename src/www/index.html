<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>DBX-ACA Network Router - Connectivity Tester</title>
  <style>
    body { font-family: system-ui, -apple-system, Roboto, "Segoe UI", Arial; padding: 2rem; background:#fff; color:#111; max-width: 1200px; margin: 0 auto; }
    header { margin-bottom: 2rem; }
    .pill { display:inline-block; background:#f3f4f6; padding:0.2rem 0.5rem; border-radius:6px; margin: 0.2rem; }
    .test-section { margin: 2rem 0; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; }
    .test-button { background:#3b82f6; color:white; padding:0.5rem 1rem; border:none; border-radius:6px; cursor:pointer; margin:0.5rem; }
    .test-button:hover { background:#2563eb; }
    .test-results { background:#f9fafb; padding:1rem; border-radius:6px; margin-top:1rem; min-height:100px; font-family:monospace; white-space:pre-wrap; }
    .status-success { color: #059669; }
    .status-error { color: #dc2626; }
    .status-info { color: #0284c7; }
  </style>
</head>
<body>
  <header>
    <h1>üîó DBX-ACA Network Router</h1>
    <p class="pill">Container App with VNet Integration</p>
    <p class="pill">SQL Database Private Endpoint Testing</p>
  </header>

  <main>
    <div class="test-section">
      <h2>üè• Health Check</h2>
      <p>Basic health check endpoint to verify the container is running.</p>
      <button class="test-button" onclick="testEndpoint('/healthz', 'health-results')">Test Health</button>
      <div id="health-results" class="test-results">Click "Test Health" to check container status...</div>
    </div>

    <div class="test-section">
      <h2>üåê Network Connectivity</h2>
      <p>Test DNS resolution and network connectivity to SQL servers.</p>
      <button class="test-button" onclick="runCommand('/api/test/network', 'network-results')">Test Network</button>
      <div id="network-results" class="test-results">Click "Test Network" to check DNS resolution and port connectivity...</div>
    </div>

    <div class="test-section">
      <h2>üóÑÔ∏è SQL Database Connectivity</h2>
      <p>Test full SQL Server connectivity including authentication.</p>
      <button class="test-button" onclick="runCommand('/api/test/sql', 'sql-results')">Test SQL Connection</button>
      <div id="sql-results" class="test-results">Click "Test SQL Connection" to verify database connectivity...</div>
    </div>

    <div class="test-section">
      <h2>üìä Environment Info</h2>
      <p>Display container environment variables and network configuration.</p>
      <button class="test-button" onclick="showEnvironment('env-results')">Show Environment</button>
      <div id="env-results" class="test-results">Click "Show Environment" to display configuration...</div>
    </div>

    <div class="test-section">
      <h2>üîß Manual Commands</h2>
      <p>Run custom commands for debugging.</p>
      <input type="text" id="custom-command" placeholder="Enter command (e.g., nslookup sql-server.database.windows.net)" style="width: 70%; padding: 0.5rem; margin-right: 0.5rem;">
      <button class="test-button" onclick="runCustomCommand()">Run Command</button>
      <div id="command-results" class="test-results">Enter a command above and click "Run Command"...</div>
    </div>
  </main>

  <script>
    async function testEndpoint(url, resultId) {
      const resultDiv = document.getElementById(resultId);
      resultDiv.innerHTML = '<span class="status-info">Testing...</span>';
      
      try {
        const response = await fetch(url);
        const text = await response.text();
        const status = response.ok ? 'success' : 'error';
        resultDiv.innerHTML = `<span class="status-${status}">Status: ${response.status}</span>\n${text}`;
      } catch (error) {
        resultDiv.innerHTML = `<span class="status-error">Error: ${error.message}</span>`;
      }
    }

    async function runCommand(apiEndpoint, resultId) {
      const resultDiv = document.getElementById(resultId);
      resultDiv.innerHTML = '<span class="status-info">Running test...</span>';
      
      try {
        const response = await fetch(apiEndpoint);
        const data = await response.json();
        
        let resultText = '';
        if (apiEndpoint.includes('/network')) {
          resultText = `<span class="status-${data.success ? 'success' : 'error'}">Network Test ${data.success ? 'PASSED' : 'FAILED'}</span>\n\n${data.stdout}`;
          if (data.stderr) resultText += `\n\nErrors:\n${data.stderr}`;
        } else if (apiEndpoint.includes('/sql')) {
          resultText = `<span class="status-${data.success ? 'success' : 'error'}">SQL Test ${data.success ? 'PASSED' : 'FAILED'}</span>\n\n`;
          resultText += JSON.stringify(data.results, null, 2);
          if (data.stderr) resultText += `\n\nErrors:\n${data.stderr}`;
        }
        
        resultDiv.innerHTML = resultText;
      } catch (error) {
        resultDiv.innerHTML = `<span class="status-error">Error: ${error.message}</span>`;
      }
    }

    async function showEnvironment(resultId) {
      const resultDiv = document.getElementById(resultId);
      resultDiv.innerHTML = '<span class="status-info">Loading environment...</span>';
      
      try {
        const response = await fetch('/api/environment');
        const data = await response.json();
        
        let envText = 'Container Environment Variables:\n\n';
        for (const [key, value] of Object.entries(data.environment)) {
          envText += `${key}: ${value}\n`;
        }
        
        resultDiv.innerHTML = envText;
      } catch (error) {
        resultDiv.innerHTML = `<span class="status-error">Error loading environment: ${error.message}</span>`;
      }
    }

    async function runCustomCommand() {
      const command = document.getElementById('custom-command').value;
      if (!command) {
        alert('Please enter a command');
        return;
      }
      
      const resultDiv = document.getElementById('command-results');
      resultDiv.innerHTML = '<span class="status-info">Running command...</span>';
      
      try {
        const response = await fetch(`/api/test/command?cmd=${encodeURIComponent(command)}`);
        const data = await response.json();
        
        if (data.error) {
          resultDiv.innerHTML = `<span class="status-error">Error: ${data.error}</span>`;
        } else {
          const status = data.success ? 'success' : 'error';
          resultDiv.innerHTML = `<span class="status-${status}">Command: ${data.command}</span>\n<span class="status-${status}">Exit Code: ${data.returncode}</span>\n\nOutput:\n${data.stdout}\n\nError Output:\n${data.stderr}`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<span class="status-error">Error: ${error.message}</span>`;
      }
    }
  </script>
</body>
</html>
